From: Markus Koschany <apo@debian.org>
Date: Fri, 1 Feb 2019 10:49:14 +0100
Subject: CVE-2019-6245

Bug-Debian: https://bugs.debian.org/919322
Origin: https://sourceforge.net/p/agg/svn/119/
---
 include/agg_rasterizer_cells_aa.h | 32 +++++++++++++++++---------------
 1 file changed, 17 insertions(+), 15 deletions(-)

diff --git a/include/agg_rasterizer_cells_aa.h b/include/agg_rasterizer_cells_aa.h
index 3a616d9..85d4bd4 100644
--- a/include/agg_rasterizer_cells_aa.h
+++ b/include/agg_rasterizer_cells_aa.h
@@ -228,7 +228,8 @@ namespace agg
         int fx1 = x1 & poly_subpixel_mask;
         int fx2 = x2 & poly_subpixel_mask;
 
-        int delta, p, first, dx;
+        int delta, p, first;
+        long long dx;
         int incr, lift, mod, rem;
 
         //trivial case. Happens often
@@ -253,7 +254,7 @@ namespace agg
         first = poly_subpixel_scale;
         incr  = 1;
 
-        dx = x2 - x1;
+        dx = (long long)x2 - (long long)x1;
 
         if(dx < 0)
         {
@@ -263,8 +264,8 @@ namespace agg
             dx    = -dx;
         }
 
-        delta = p / dx;
-        mod   = p % dx;
+        delta = (int)(p / dx);
+        mod   = (int)(p % dx);
 
         if(mod < 0)
         {
@@ -282,8 +283,8 @@ namespace agg
         if(ex1 != ex2)
         {
             p     = poly_subpixel_scale * (y2 - y1 + delta);
-            lift  = p / dx;
-            rem   = p % dx;
+            lift  = (int)(p / dx);
+            rem   = (int)(p % dx);
 
             if (rem < 0)
             {
@@ -328,12 +329,12 @@ namespace agg
     {
         enum dx_limit_e { dx_limit = 16384 << poly_subpixel_shift };
 
-        int dx = x2 - x1;
+        long long dx = (long long)x2 - (long long)x1;
 
         if(dx >= dx_limit || dx <= -dx_limit)
         {
-            int cx = (x1 + x2) >> 1;
-            int cy = (y1 + y2) >> 1;
+            int cx = (int)(((long long)x1 + (long long)x2) >> 1);
+            int cy = (int)(((long long)y1 + (long long)y2) >> 1);
 
             // Bail if values are so large they are likely to wrap
             if ((std::abs(x1) >= std::numeric_limits<int>::max()/2) || (std::abs(y1) >= std::numeric_limits<int>::max()/2) ||
@@ -344,7 +345,7 @@ namespace agg
             line(cx, cy, x2, y2);
         }
 
-        int dy = y2 - y1;
+        long long dy = (long long)y2 - (long long)y1;
         int ex1 = x1 >> poly_subpixel_shift;
         int ex2 = x2 >> poly_subpixel_shift;
         int ey1 = y1 >> poly_subpixel_shift;
@@ -353,7 +354,8 @@ namespace agg
         int fy2 = y2 & poly_subpixel_mask;
 
         int x_from, x_to;
-        int p, rem, mod, lift, delta, first, incr;
+        int rem, mod, lift, delta, first, incr;
+        long long p;
 
         if(ex1 < m_min_x) m_min_x = ex1;
         if(ex1 > m_max_x) m_max_x = ex1;
@@ -430,8 +432,8 @@ namespace agg
             dy    = -dy;
         }
 
-        delta = p / dy;
-        mod   = p % dy;
+        delta = (int)(p / dy);
+        mod   = (int)(p % dy);
 
         if(mod < 0)
         {
@@ -448,8 +450,8 @@ namespace agg
         if(ey1 != ey2)
         {
             p     = poly_subpixel_scale * dx;
-            lift  = p / dy;
-            rem   = p % dy;
+            lift  = (int)(p / dy);
+            rem   = (int)(p % dy);
 
             if(rem < 0)
             {
